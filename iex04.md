# インターネット工学演習 04

# 紙とペンを用意しましょう

### 山崎のssh サーバにssh ログインしてください


## nanoエディターの練習

### ファイルの作成

```
nano test01.txt
```

### 基本操作

|操作　|キーボード|
| --- | --- |
|一行削除|Ctrl + K|
|Back Space 　	|Ctrl + H|
|Delete	|Ctrl + D|
|貼り付け　|Ctrl + U|
|取り消し|Esc + U|
|やり直し|Esc + E|
|上書き保存|Ctrl + S|
|名前をつけて保存|Ctrl + O|
|閉じる|Ctrl + X|

|移動単位|　　	キーボード|
| ---| --- |
|右| Ctrl + f|
|左| Ctrl + fb
|下| Ctrl + n|
|上| Ctrl + p|
|行頭　|Ctrl + A|
|行末　|Ctrl + E|
|次ページ　|	Ctrl + Y|
|前ページ　|	Ctrl + N|

|検索と置換|キーボード|
| --- | --- |
|後方検索|Ctrl + W|
|前方検索　|Ctrl + Q|
|前方へ続けて検索　|	Alt + W|
|後方へ続けて検索　|	Alt + Q|
|置換　　|Ctrl + WR|

### 試しに次の内容を入力して保存してください

```
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: true
      dhcp6: true
```

### ip route コマンドの確認

```bash
ip route
```

## 班分け（10班に分けます）

* １班　学籍番号の最終桁が１の人
* ２班　学籍番号の最終桁が２の人
* ３班　学籍番号の最終桁が３の人
* ４班　学籍番号の最終桁が４の人
* ５班　学籍番号の最終桁が５の人
* ６班　学籍番号の最終桁が６の人
* ７班　学籍番号の最終桁が７の人
* ８班　学籍番号の最終桁が８の人
* ９班　学籍番号の最終桁が９の人
* 10班　学籍番号の最終桁が０の人

## 管理するルータ

* G1R  １班
* G2R　２班
* G3R　３班
* G4R　４班
* G5R　５班
* G6R　６班
* G7R　７班
* G8R　８班
* G9R　９班
* G10R　１０班



## ネットワーク構成図

R が付いているのがルータ

### 1セグメント（現在のネットワーク）

#### ネットワーク構成図を実際に紙に書いてみましょう

★　自分の班のルータを丸で囲ってください。

```
                          Internet
                              |
              253             1      
    -----------+--------------+------------------------------------------------------ 192.168.0.0/24
        [ router1 ](SSH)         
               |                         
               |
  2    3   4   1  18  19  34  35  50  66  67  82  83  98  99 114 130 131 146 147 162
--+----+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+-- 192.168.1.0/24
 G8R  G4R G1R     G2R G1  G3R G2  G3  G5R G4  G6R G5  G7R G6  G7  G9R G8 G10R G9 G10

 

```


## 担当ルータに ssh ログイン

ユーザ名は ubuntu です

```
ssh ubuntu@IPアドレス
```

### ルータのIPアドレス


|  ルータ  |  eth0  |
| ---- | ---- | ----|
|G1R|192.168.1.4|
|G2R|192.168.1.18|
|G3R|192.168.1.34|
|G4R|192.168.1.3|
|G5R|192.168.1.66|
|G6R|192.168.1.82|
|G7R|192.168.1.98|
|G8R|192.168.1.2|
|G9R|192.168.1.130|
|G10R|192.168.1.146|

### 自分が入ったマシンに痕跡を残す

touch コマンドで空のファイルを作成してみましょう

```
touch <ファイル名>
```

```
touch 山崎参上
```


## ルータの基本

ubuntu マシンをルータ化する場合


### ipfoward の設定（すでに設定済です）

```
 sudo nano /etc/sysctl.conf
```


以下の2行のコメントをはずすとルータ化されます。
（再起動が必要）


```
# Uncomment the next line to enable packet forwarding for IPv4
net.ipv4.ip_forward=1

# Uncomment the next line to enable packet forwarding for IPv6
#  Enabling this option disables Stateless Address Autoconfiguration
#  based on Router Advertisements for this host
net.ipv6.conf.all.forwarding=1

```

再起動方法（今回は実行しない）

```
sudo reboot
```

## ルーターにIP アドレスを設定する方法（まだ見るだけ）

### netplanコマンドの設定ファイルを編集する

設定ファイルの文法はここに説明されています。

[https://ubuntu.com/server/docs/network-configuration](https://ubuntu.com/server/docs/network-configuration)


#### 設定ファイル（例）

/etc/netplan/99_config.yaml

```
sudo nano /etc/netplan/99_config.yaml
```

編集前（eth0)  だけの設定しかない

##### 以下を確認する

* eth0 
* addresses
* gateway4
* nameservers
* routes

例

```
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: false
      dhcp6: false
      addresses: [192.168.1.4/24]
      gateway4: 192.168.1.1
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
```


## 各ルータの eth1 側のIPアドレス

```
                          Internet
                              |
              253             1      
    -----------+--------------+------------------------------------------------------ 192.168.0.0/24
        [ router1 ](SSH)         
               |                         
               |
  2    3   4   1  18  19  34  35  50  66  67  82  83  98  99 114 130 131 146 147 162
--+----+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+-- 192.168.1.0/24
 G8R  G4R G1R     G2R G1  G3R G2  G3  G5R G4  G6R G5  G7R G6  G7  G9R G8 G10R G9 G10
  |    |   |       |       |           |       |       |           |       |
 129  65  17      33      49          81      97     113         145      161
 

```

### traceroute のインストール

```
sudo apt install traceroute
```

### ルーティングの確認

他のすべての班のサーバとルータに ping が到達することを確認する

traceroute で経路を確認する

```
ping サーバやルータのIPアドレス
```

```
traceroute サーバやルータのIPアドレス
```


### ルータの eth1 を含んだIPアドレス

|  ルータ  |  eth0  | eth1|
| ---- | ---- | ----|
|G1R|192.168.1.4|192.168.1.17|
|G2R|192.168.1.18|192.168.1.33|
|G3R|192.168.1.34|192.168.1.49|
|G4R|192.168.1.3|192.168.1.65|
|G5R|192.168.1.66|192.168.1.81
|G6R|192.168.1.82|192.168.1.97|
|G7R|192.168.1.98|192.168.1.113|
|G8R|192.168.1.2|192.168.1.129|
|G9R|192.168.1.130|192.168.1.145|
|G10R|192.168.1.146|192.168.1.161|



### ルータのeth1 のIPアドレスを設定する

編集後（eth1の設定を追加）

例

```
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: false
      dhcp6: false
      addresses: [192.168.1.4/24]
      gateway4: 192.168.1.1
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
    eth1:
      dhcp4: false
      dhcp6: false
      addresses: [192.168.1.17/24]
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
```

### netplan コマンドの実行によって設定を反映させる

★注意！　リモート作業で設定に間違いがあると２度とつながらなくなります

```
sudo netplan apply
```

### 設定の確認

```
ip addr
```

### 各班のサーバに ssh ログインする

１班はG1にssh ログイン，…

```
ssh ubuntu@各班のサーバのIPアドレス
```


### ルーティングの確認

他のすべての班のサーバとルータに ping が到達することを確認する

traceroute で経路を確認する

```
ping サーバやルータのIPアドレス

traceroute サーバやルータのIPアドレス
```

## 各班のルータにeth1 側からssh ログインできることを確認する


```
ssh ubuntu@各班のルータのeth1側のIPアドレス
```


ログインに成功すれば成功！

### host名の設定（おまけ）

ホスト名を付けておくとわかりやすい（演習環境ではすでに名前をつけています）


```
sudo hostnamectl set-hostname <ホスト名>
```

# 今後のネットワーク

### 2セグメントの例（第１段階）次回の授業

★サブネットマスクが25ビットになっていることに注意！

```
                          Internet
                              |
              253             1         
    -----------+--------------+---------------------------------- 192.168.0.0/24
        [ router1 ](SSH)           
               |                   
               |
  2    3   4   1  18  19  34  35  50  66  67  82  83  98  99 114 
--+----+---+---+---+---+---+---+---+---+---+---+---+---+---+---+-- 192.168.1.0/25
 G8R  G4R G1R     G2R G1  G3R G2  G3  G5R G4  G6R G5  G7R G6  G7 
  |
  |
 129  130  131  146  147  162
--+----+----+----+----+----+-------------------------------------- 192.168.1.128/25
      G9R  G8   G10R G9  G10
 
```

### 3セグメント (4セグメント）の例（第２段階）

★サブネットマスクが26ビットになっていることに注意！

```
                           Internet
                              |
              253             1         
    -----------+--------------+------------------------- 192.168.0.0/24
        [ router1 ](SSH)           
               |                   
               |
  2    3   4   1  18  19  34  35  50 
--+----+---+---+---+---+---+---+---+-------------------- 192.168.1.0/26
 G8R  G4R G1R     G2R G1  G3R G2  G3 
  |    |
  |    |
  |   65  66  67  82  83  98  99  114  
  |   -+---+---+---+---+---+---+---+-------------------- 192.168.1.64/26
  |       G5R G4  G6R G5  G7R G6  G7   
  |
  |
 129  130  131  146  147  162
--+----+----+----+----+----+---------------------------- 192.168.1.128/25
      G9R  G8   G10R G9  G10
 


```

### 6セグメント（８セグメント）の例（第３段階）
★サブネットマスクが27ビットになっていることに注意！

```
                                     Internet
                                         |
                        253              1           
    ----------------------+--------------+----------- 192.168.0.0/24
                      [ router1 ](SSH)
                          |
                          |
  2       3       4       1    18    19  
--+-------+-------+-------+----+-----+--------------- 192.168.1.0/27
[G8R]   [G4R]   [G1R]        [G2R]  G1   
  |       |                    |
  |       |                    |
  |       |                    33    34    35    50   
  |       |                 ---+-----+-----+-----+--- 192.168.1.32/27
  |       |                        [G3R]   G2    G3     
  |       |
  |       |
  |       65    66    67    82    83     
  |     --+-----+-----+-----+-----+------------------ 192.168.1.64/27
  |           [G5R]   G4  [G6R]   G5     
  |                         |
  |                         |
  |                         97    98    99   114  
  |                    -----+-----+-----+-----+------ 192.168.1.96/27
  |                             [G7R]   G6    G7   
  |
  |
 129     130   131   146   147  
--+-------+-----+-----+-----+------------------------ 192.168.1.128/27
        [G9R]  G8  [G10R]   G9    
                     |
                     |
                    161   162
                 ----+-----+------------------------- 192.168.1.160/27
                          G10

```

### 11セグメント（16セグメント）の例（第４段階）

★サブネットマスクが28ビットになっていることに注意！

```
                                     Internet
                                         |
                        253              1           
    ----------------------+--------------+----------- 192.168.0.0/24
                      [ router1 ](SSH)
                          |
                          |
  2       3       4       1    18     
--+-------+-------+-------+----+--------------------- 192.168.1.0/28
[G8R]   [G4R]   [G1R]          
  |       |       |
  |       |       |
  |       |       17          18    19
  |       |      -+------------+-----+--------------- 192.168.16.0/28
  |       |                  [G2R]  G1 
  |       |                    |
  |       |                    |
  |       |                   33    34    35    
  |       |                 ---+-----+-----+--------- 192.168.1.32/28
  |       |                        [G3R]   G2      
  |       |                          |
  |       |                          |
  |       |                         49    50   
  |       |                      ----+-----+--------- 192.168.1.48/28
  |       |                               G3     
  |       |
  |       |
  |       65    66    67    82    83     
  |     --+-----+-----+-----+-----+------------------ 192.168.1.64/28
  |           [G5R]   G4    
  |             |
  |             |
  |            81          82
  |           --+-----------+-----+------------------ 192.168.1.80/28
  |                       [G6R]   G5  
  |                         |
  |                         |
  |                         97    98    99
  |                    -----+-----+-----+------------ 192.168.1.96/28
  |                             [G7R]  G6 
  |                               |
  |                               |
  |                              113   114  
  |                            ---+-----+------------ 192.168.1.112/28
  |                                    G7   
  |
  |
 129     130   131   
--+-------+-----+------------------------------------ 192.168.1.128/27
        [G9R]  G8     
          |
          |
         145   146   147
      ----+-----+-----+------------------------------ 192.168.1.144/27
             [G10R]   G9 
                |
                |
               161   162
            ----+-----+------------------------------ 192.168.1.160/27
                    G10
 


```


# 従来の演習

----


* 班の3人ごとに1台のルータを配布
* ルータに電源の入力
* リセットボタンをボールペンの先で20秒程度押して設定をリセットする

## ルータの接続
### 事前の状態

* 机のハブから6台のlinux PC にLANケーブルで接続されている
* 机のハブとサーバルームからのLANケーブルが接続されている

### 変更

1. 机のハブから6台のlinux PC にLANケーブルをはずす
2. 1台のルータのLAN側ポートと3台のLinux PC をLANケーブルで接続する
3. 班ごとに机のハブから2台のルータのWANポートにLANケーブルで接続する

## linuxマシンの設定確認

* ネットワーク接続設定がDHCPでの自動接続であることを確認する
* インターネットに接続できていることを確認する


## ルータの基本設定

1. ブラウザからルータにアクセスする (192.168.11.1)
2. ユーザ名：root パスワードなしでログインする
3. 機能を確認する

### LAN設定の修正

LAN側のIPアドレスを変更してみる

### ping で確認




