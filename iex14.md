# インターネット工学演習 14

## ネットワーク性能評価ツールのインストール

### 事前にOS をupdate, upgradeしておく

```bash
sudo apt update
sudo apt -y upgrade
```

### apache bench

apacheをインストールすると自動的にインストールされる

### ping

不要

### iperf3

```bash
sudo apt install -y iperf3
```

### munin

```bash
sudo apt install -y libcgi-fast-perl libapache2-mod-fcgid
sudo apt install -y munin munin-node munin-plugins-extra
```

```bash
sudo systemctl start munin-node
sudo systemctl restart apache2
```

### munin.conf

```
sudo nano /etc/munin/munin.conf
```

以下のように修正 
サーバアドレスに注意

```
# Example configuration file for Munin, generated by 'make build'

# The next three variables specifies where the location of the RRD
# databases, the HTML output, logs and the lock/pid files. They all
# must be writable by the user running munin-cron. They are all
# defaulted to the values you see here.
#
dbdir /var/lib/munin
htmldir /var/cache/munin/www
logdir /var/log/munin
rundir /var/run/munin

# Where to look for the HTML templates
#
tmpldir /etc/munin/templates

# Where to look for the static www files
#
#staticdir /etc/munin/static

# temporary cgi files are here. note that it has to be writable by
# the cgi user (usually nobody or httpd).
#
# cgitmpdir /var/lib/munin/cgi-tmp

# (Exactly one) directory to include all files from.
includedir /etc/munin/munin-conf.d
[...]
# a simple host tree
[localhost.localdomein]
 address 127.0.0.1
 use_node_name yes
[...]
```

### apache24.conf

```
sudo mv /etc/munin/apache24.conf /etc/munin/apache24.conf_bak
```

```
sudo nano /etc/munin/apache24.conf
```

以下をペースト

```
Alias /munin /var/cache/munin/www
<Directory /var/cache/munin/www>
 # Require local
 Require all granted
 Options FollowSymLinks SymLinksIfOwnerMatch
 Options None
</Directory>

ScriptAlias /munin-cgi/munin-cgi-graph /usr/lib/munin/cgi/munin-cgi-graph
<Location /munin-cgi/munin-cgi-graph>
 # Require local
 Require all granted
 Options FollowSymLinks SymLinksIfOwnerMatch
 <IfModule mod_fcgid.c>
 SetHandler fcgid-script
 </IfModule>
 <IfModule !mod_fcgid.c>
 SetHandler cgi-script
 </IfModule>
</Location>
```

### Restart Apache:

```
sudo service apache2 restart
sudo service munin-node restart
```



## apache bench

WEBサーバの性能測定

WEBサーバのパフォーマンスデバッギング

* Apache Benchは、DOS攻撃にも使えるツールです!! 使用する際は十分注意してください!!

* Apacheで標準に付いているWEBサーバの性能を計測するためのコマンド


|オプション名	|説明|
|:--:|:--:|
|-n 数値	|リクエストの総数を数値で指定|
|-c 数値	|同時に発行するリクエストの数を数値で指定|
|-t 数値	|サーバからのレスポンスの待ち時間（秒）を数値で指定|
|-A ユーザー名:パスワード	|ベーシック認証が必要なコンテンツにテストする|
|-P ユーザー名:パスワード	|認証の必要なプロキシを通じてテストする|
|-X プロキシサーバ名:ポート番号	|プロキシ経由でリクエストする場合に指定|
|-V	|バージョンを表示|
|-h	|ヘルプを表示|

#### 使用法

隣の人のマシンのIPアドレスを調べる


```bash
ab -n 10000 -c 100 http://隣の人のIPアドレス
ab -n 10000 -c 100 http://192.168.0.27/
```

* Complete requestsが正常に処理したリクエスト数
* Failed requestsは、処理に失敗したリクエスト数

* 何リクエストまで耐えられるか
	* Failed requests: を見る
	
	
	-n と -cの値を増やしていく


* 秒間どれくらいのリクエストをさばけるか？
	* Requests per second　を見る

* パフォーマンス
	* Time per request: を見る

## ping による速度測定

* pingコマンドの主なオプション

|オプション 引数	|意味|
|:--|:--|
|-c 数	|パケットの送信回数を指定する|
|-i 秒	|パケットの送信間隔を秒単位で指定する|
|-n	|数値のみ出力する（名前解決を行わない）|
|-r	|ホストへ直接パケットを送信する（ルーティングしない）|
|-R	|パケットの経路を表示する|
|-q	|コマンド実行開始時と終了時のメッセージのみを表示します。|
|-s サイズ	|パケットサイズをバイト単位で指定する（初期値は56）|
|-t TTL値	|パケットのTTL（Time to Live）値を指定する|
|-v	|詳細情報を表示する|

```bash
ping -c 5 -s 1400 -i 0.5 157.13.1.1
```

パケットサイズはフラグメントを起こさないサイズでないとTTLが測定できない


## iperf3 

* サーバとクライアントで測定する
* グループ内で互いのIPアドレスを確認する

#### サーバ側

```bash
iperf3 -s
```

#### クライアント側

```bash
iperf3 -c 
```

## munin

自分のmunin サイトの状態をを確認

* 1時間程度経過した後

```
http://106.157.214.199:8010/munin
```





# IPv6



* 共通のIDとパスワードでログインしてもらいます。

* ログイン後は，これまでと同じです。

### サーバの鍵を消さないと接続できません。


## Windows 10  PowerShell の場合

.ssh というファイルがサーバの鍵です

```
cd ~
rm .ssh
```
 
## Windows 10 Putty の場合

すみません。難しいので PowerShell でやってください

## MacOSX ターミナルの場合

```
cd ~
rm -fr .ssh
```

# SSHログイン(IPアドレス 106.157.214.199)

### kindai という共通ユーザIDでログインしてください

* ID: kindai
* パスワード：nas......jin

```bash
ssh kindai@106.157.214.199
```


#### ipv6アドレスの確認

```
ifconfig
```

```
ip -6 a
```

* グローバルユニキャストアドレスの確認
* eno1 の 240f:で始まるアドレスをメモ

* リンクローカルユニキャストアドレスの確認
* eno1 の fe80:: で始まるアドレスをメモ


#### netstat
 
 ```
 netstat -rnA inet6
 ```

### ipv6 ルーティングテーブルの確認

```
ip -6 r
```

#### DNS でIPv6アドレスを確認

## DNSの　ipv6 アドレス

山崎家のプロバイダのDNS

```
2001:268:fd07:4::1
```

```
whois 2001:268:fd07:4::1
```


#### ping6　で ipv6 のDNSサーバまでping をかけてみる

```
ping6 2001:268:fd07:4::1
```

#### google のipv6アドレスの確認

```
host -t AAAA ipv6.google.com
 
 
2404:6800:4004:80b::200e
 
ping6 2404:6800:4004:80b::200e
```

```
ping6 ipv6.google.com
```

## traceroute

```
traceroute google.com
```

### DNS でIPアドレスを確認

```
host -t AAAA google.com
```




### Rマシンへssh (これまで同様自分のアカウントでログインできます）

```bash
ssh ユーザID@192.168.0.27
```

#### ipv6アドレスの確認

```
ifconfig
```

```
ip -6 a
```

#### netstat
 
 ```
 netstat -rnA inet6
 ```

## ping による速度測定

### ipv4の速度

google.com

```
host -t A google.com
```


```
ping -c 5 -s 1400 -i 0.5 172.217.161.206
```

### ipv6の速度

```
host -t AAAA google.com
```


```
ping6 -c 5 -s 1400 -i 0.5 2404:6800:400a:80b::200e
```


### A0マシンへssh (これまで同様自分のアカウントでログインできます）

```bash
ssh ユーザID@192.168.0.35
```


#### ipv6アドレスの確認

```
ifconfig

```

### netstat
 
 ```
 netstat -rnA inet6
 ```
 
## ipv6ではルーティングできていない

以下は失敗する

```
ping6 2404:6800:4004:818::200e
```

 